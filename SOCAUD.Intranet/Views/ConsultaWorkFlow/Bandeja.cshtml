@using SOCAUD.Common.Enum;

@{
    ViewBag.PageTitle = "Flujo de Aprobación";
    ViewBag.PageDescription = "Flujo de Aprobación";
    ViewBag.PageDescription = "Documentos oficiales";
}

<div class="row">
    <div class="col-md-12">
        <div class="box box-primary color-palette-box">
            <div class="box-header with-border">
                <h3 class="box-title">Flujo de Aprobación</h3>
            </div>
            <div class="box-body">

                <div class="form-group">
                    <div class="row">
                        <div class="col-md-3">
                            <label>Tipo Documento</label>
                            <select id="cboTipoDocumento" class="form-control">
                                <option value="">Seleccione</option>
                                <option value="C">CRONOGRAMA</option>
                                <option value="B">BASES</option>
                                <option value="P">PUBLICACION</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Inicio</label>
                            <div class="input-group date">
                                <input type="text" id="txtFechaInicio" name="txtFechaInicio" class="form-control" />
                                <span class="input-group-addon">
                                    <i class="fa fa-calendar bigger-110"></i>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label>Fin</label>
                            <div class="input-group date">
                                <input type="text" id="txtFechaFin" name="txtFechaFin" class="form-control" />
                                <span class="input-group-addon">
                                    <i class="fa fa-calendar bigger-110"></i>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <br />
                            <button type="button" id="btnBuscarWF" name="btnBuscarWF" class="btn btn-default"><i class="fa fa-search"></i>&nbsp;Buscar</button>
                        </div>
                    </div>
                </div>
 
                <div class="form-group">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="tabFlujoAprobacion" class="table table-striped table-bordered" cellpadding="0" cellspacing="0" border="0"></table>
                        </div>
                    </div>
                </div>
  
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modalWorkflow" tabindex="-1" role="dialog" aria-hidden="true"></div>


@section scripts {
    <script type="text/javascript" language="javascript">




        $(document).ready(function () {

            $('#txtFechaInicio').datepicker({
                format: "dd/mm/yyyy"
            }).next().on(ace.click_event, function () {
                $(this).prev().focus();
            });

            $('#txtFechaFin').datepicker({
                format: "dd/mm/yyyy"
            }).next().on(ace.click_event, function () {
                $(this).prev().focus();
            });

            $("#btnBuscarWF").click(listarFlujoTrabajo);
            listarFlujoTrabajo();
        });

        var _dataFlujoAprobacion_ = null;
        var tabFlujoAprobacion = $("#tabFlujoAprobacion").dataTable({
            "info": false,
            "bServerSide": false,
            "data": _dataFlujoAprobacion_,
            "order": [[2, "asc"]],
            "columns": [
                {
                    "bSortable": false,
                    "sClass": "center",
                    "sWidth": "5%",
                    "render": function (data, type, row) {
                        return "<center><button class='btn btn-primary' title='Ver Detalle' type='button' onclick='VerDetalleFlujo(" + row[1] + ",\"" + row[0] + "\")';><i class='fa fa-search-plus'></i></button></center>";
                    }
                },
                //{ "sTitle": "TIPDOC", "visible" : false },
                { "sTitle": "CODDOC", "visible": false },
                { "sTitle": "Tipo Documento" },
                { "sTitle": "Descripción" },
                { "sTitle": "Fecha/Hora" },
                {
                    "bSortable": false,
                    "sClass": "center",
                    "render": function (data, type, row) {
                        return "<center><button class='btn btn-primary' title='Ver Documento' type='button' onclick='VerDocumento(" + row[1] + ",\"" + row[0] + "\")';><i class='fa fa-download'></i></button></center>";
                    }
                }
            ]
        });

        function listarFlujoTrabajo() {
            $.ajax({
                url: '@Url.Action("ListarFlujoCabecera", "ConsultaWorkFlow")',
                type: 'POST',
                async: false,
                data: { tipoDoc: $("#cboTipoDocumento").val(), fecIni: $("#txtFechaInicio").val(), fecFin: $("#txtFechaFin").val() },
                success: function (result) {
                    _dataFlujoAprobacion_ = result;
                    tabFlujoAprobacion.fnReloadData(_dataFlujoAprobacion_);
                }
            });
        }

        function VerDetalleFlujo(Documento,tipoDoc) {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("Solicitud", "ConsultaWorkFlow")',
                data: { tipodoc: tipoDoc, doc: Documento },
                success: function (result) {
                    $("#modalWorkflow").empty().html(result).modal();
                }
            });
        }

        function VerDocumento(Documento, tipoDoc) {
            var url = "";
            if (tipoDoc == "C") {
                url = '@Url.Action("CreateReporteCronograma", "Cronograma", new { Area = "", id = "_id_" })'.replace('_id_', Documento);
            }
            else if (tipoDoc == "B") {
                url = '@Url.Action("CreateReporteBase", "Base", new { Area = "", id = "_id_" })'.replace('_id_', Documento);
            } else {
                url = '@Url.Action("CreateReporteConcurso", "Evaluador", new { Area = "Publicacion", id = "_id_" })'.replace('_id_', Documento);
            }
            window.open(url);
        }


    </script>

}