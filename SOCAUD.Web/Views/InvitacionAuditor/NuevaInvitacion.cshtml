@using SOCAUD.Common.Enum;
@using SOCAUD.Common.Constantes;

@model SOCAUD.Web.Models.InvitacionModel
@{
    ViewBag.PageTitle = "Invitaciones";
    ViewBag.PageDescription = "Invitaciones";
    ViewBag.PageDescription = "Nueva Invitación";
    //Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="row">
    <div class="col-md-12">
        <div class="box box-primary color-palette-box">
            <div class="box-header with-border">
                <h3 class="box-title">Nueva Invitación</h3>
            </div>
            <div class="box-body">

                <div class="form-group">
                    <div class="row">
                        <div class="col-md-6">
                            <label>Publicación</label>
                            @Html.DropDownListFor(c => c.CODPUB, Model.cboPublicaciones, "Seleccione", new { @class = "form-control" })
                            @Html.ValidationMessageFor(c => c.CODPUB)
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-md-8">
                            @Html.LabelFor(c => c.CODBAS)
                                @Html.DropDownListFor(c => c.CODBAS, Model.cboBases, "Seleccione", new { @class = "form-control" })
                                @Html.ValidationMessageFor(c => c.CODBAS)
                        </div>
                        <div class="col-md-4">
                            @Html.LabelFor(c => c.CODSERAUD)
                            @Html.DropDownListFor(c => c.CODSERAUD, Model.cboServiciosAuditoria, "Seleccione", new { @class = "form-control" })
                            @Html.ValidationMessageFor(c => c.CODSERAUD)
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="row">
                        <div class="col-md-12">

                            <!--INICIOOOOOOOO-->
                            <ul class="nav nav-tabs" role="tablist">
                                <li role="presentation" class="active"><a href="#tabsMejorEquipo" aria-controls="home" role="tab" data-toggle="tab">Mejor Equipo</a></li>
                                <li role="presentation"><a href="#tabsAuditoresAptos" aria-controls="profile" role="tab" data-toggle="tab">Auditores Disponibles</a></li>
                            </ul>

                            <div class="tab-content">
                                <div role="tabpanel" class="tab-pane active" id="tabsMejorEquipo">

                                    <!--INICIO-->

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="box box-primary color-palette-box">
                                                <div class="box-header with-border">
                                                    <h3 class="box-title"><i class="fa fa-users"></i>&nbsp;Auditores con mejor puntaje</h3>
                                                </div>
                                                <div class="box-body">

                                                    <div class="form-group">
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <table id="tabMejorEquipo" class="table table-striped table-bordered" cellpadding="0" cellspacing="0" border="0"></table>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!--FIN-->

                                </div>
                                <div role="tabpanel" class="tab-pane" id="tabsAuditoresAptos">

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="box box-primary color-palette-box">
                                                <div class="box-header with-border">
                                                    <h3 class="box-title"><i class="fa fa-users"></i>&nbsp;Auditores que califican para la auditoria</h3>
                                                </div>
                                                <div class="box-body">

                                                    <div class="form-group">
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <table id="tabAuditoresAptos" class="table table-striped table-bordered" cellpadding="0" cellspacing="0" border="0"></table>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--FIN FINNNNNN-->
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-md-12">
                            <center>
                                <button class="btn btn-primary" type="button" id="btnAgregarAuditores"><i class="fa fa-save"></i>&nbsp;Invitar Auditores Seleccionados</button>
                            </center>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="tabInvitaciones" class="table table-striped table-bordered" cellpadding="0" cellspacing="0" border="0"></table>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="row">
                        <div class="col-md-12">
                            <button type="button" id="btnRegresar" onclick="regresar();" class="btn btn-default"><i class="fa fa-chevron-left"></i>&nbsp;Regresar</button>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalBusquedaAuditor" tabindex="-1" role="dialog" aria-hidden="true"></div>

<div class="modal fade" id="modalAgendaDisponibilidadAuditor" tabindex="-1" role="dialog" aria-hidden="true"></div>

@section scripts {

    <script type="text/javascript" language="javascript">


        var _dataInvitaciones_ = null;
        var _dataMejorEquipo_ = null;
        var _dataAuditoresAptos_ = null;

        var tabInvitaciones = $("#tabInvitaciones").dataTable({
            "info": false,
            "bServerSide": false,
            "data": _dataInvitaciones_,
            "order": [[1, "asc"]],
            "columns": [
                {
                    "bSortable": false,
                    "sClass": "center",
                    "sWidth": "5%",
                    "render": function (data, type, row) {

                        return '<center><button class="btn btn-primary" title="Agregar agenda" type="button" onclick="popupAgendaAuditores(' + row[0] + ');"><i class="fa fa-calendar"></i></button></center>';
                    }
                },
                { "sTitle": "Auditor" },
                { "sTitle": "DNI" },
                { "sTitle": "Entidad" },
                { "sTitle": "Periodo" },
                { "sTitle": "Cargo" },
                { "sTitle": "Fecha Acepto Invitacion", "sClass": "center" },
                { "sTitle": "Estado", "sClass": "center" },
                {
                    "bSortable": false,
                    "sClass": "center",
                    "sWidth": "5%",
                    "render": function (data, type, row) {
                        if (row[8] == '@Convert.ToInt32(Estado.Invitacion.Elaboracion)')
                            return '<center><button class="btn btn-danger" title="Eliminar" type="button" onclick="eliminarInvitacion(' + row[0] + ');"><i class="fa fa-trash"></i></button></center>';
                        else
                            return "";
                    }
                },
                {
                    "bSortable": false,
                    "sClass": "center",
                    "sWidth": "5%",
                    "render": function (data, type, row) {
                        if (row[8] == '@Convert.ToInt32(Estado.Invitacion.Elaboracion)')
                            return '<center><button class="btn btn-success" title="Enviar" type="button" onclick="enviarInvitacion(' + row[0] + ');"><i class="fa fa-share"></i></button></center>';
                        else
                            return "";
                    }
                }
            ]

        });

        $(document).ready(function () {
            $("#CODPUB").change(function () {
                cargarComboBases();
            });
            $("#CODBAS").change(function () {
                cargarServiciosAuditoria();
            });
            $("#CODSERAUD").change(function () {
                listarInvitaciones();
                listarMejorEquipo($("#CODPUB").val(), $("#CODSERAUD").val());
                listarAuditoresAptos($("#CODPUB").val(), $("#CODSERAUD").val());
            });

            $("#btnAgregarAuditores").click(invitarAuditores);
        });


        function regresar() {
            document.location.href = '@Url.Action("Index","InvitacionAuditor")';
        }

        function invitarAuditores() {
            var codigosAuditorServicio = "";

            $("input[name='chkAuditorServicio']:checked").each(function (i, v) {
                if (codigosAuditorServicio == "")
                    codigosAuditorServicio = $(this).val();
                else
                    codigosAuditorServicio = codigosAuditorServicio + "," + $(this).val();
            });

            if (codigosAuditorServicio == "") {
                new PNotify({
                    title: 'Respuesta Sistema!',
                    type: "error",
                    text: "Debe seleccionar al menos un auditor"
                });
                return
            }

            $.ajax({
                url: '@Url.Action("InvitarAuditores", "InvitacionAuditor")',
                type: 'POST',
                async: false,
                data: {
                    idPub: $("#CODPUB").val(),
                    idSerAud: $("#CODSERAUD").val(),
                    strAudCargo: codigosAuditorServicio
                },
                success: function (result) {
                    mostrarNotificacion(result);
                    listarInvitaciones();
                }
            });
        }


        function popupAgendaAuditores(id) {

            $.ajax({
                type: 'POST',
                url: '@Url.Action("AgendaAuditor", "InvitacionAuditor")',
                data: { idInvitacion: id },
                success: function (result) {
                    $("#modalAgendaDisponibilidadAuditor").empty().html(result).modal();
                }
            });
        }


        function cargarComboBases() {
            $.ajax({
                type: "POST",
                url: '@Url.Action("listarBases", "InvitacionAuditor")',
                data: { idPub: $("#CODPUB").val() },
                dataType: "json",
                success: function (result) {
                    $("#CODBAS option").not(":first").remove();
                    $.each(result, function (i, v) {
                        $("#CODBAS").append("<option value='" + v.CODBAS + "'>" + v.DESBAS + "</option>");
                    });
                }
            });
        }



        function cargarServiciosAuditoria() {
            $.ajax({
                type: "POST",
                url: '@Url.Action("listarServicios", "InvitacionAuditor")',
                data: { idBase: $("#CODBAS").val() },
                dataType: "json",
                success: function (result) {
                    $("#CODSERAUD option").not(":first").remove();
                    $.each(result, function (i, v) {
                        $("#CODSERAUD").append("<option value='" + v.Value + "'>" + v.Text + "</option>");
                    });
                }
            });
        }

        function listarInvitaciones() {
            $.ajax({
                url: '@Url.Action("ListadoInvitacionesPorSOA", "InvitacionAuditor")',
                type: 'POST',
                async: false,
                data: { idPub: $("#CODPUB").val(), idSerAud: $("#CODSERAUD").val() },
                success: function (result) {
                    _dataInvitaciones_ = result;
                    tabInvitaciones.fnReloadData(_dataInvitaciones_);
                }
            });
        }




        function enviarInvitacion(id) {

            bootbox.confirm(parametros.general.mensajeConfirmacion, function (result) {
                if (result) {
                    $.ajax({
                        url: '@Url.Action("EnviarInvitacionAuditor", "InvitacionAuditor")',
                        type: 'POST',
                        async: false,
                        data: { id: id },
                        success: function (result) {
                            mostrarNotificacion(result);
                            listarInvitaciones();
                        }
                    });
                }
            });
        }

        function eliminarInvitacion(id) {
            bootbox.confirm(parametros.general.mensajeConfirmacion, function (result) {

                if (result) {
                    $.ajax({
                        url: '@Url.Action("EliminarInvitacion", "InvitacionAuditor")',
                        type: 'POST',
                        async: false,
                        data: { id: id },
                        success: function (result) {
                            mostrarNotificacion(result);
                            listarInvitaciones();
                        }
                    });
                }
            });
        }



        var tabMejorEquipo = $("#tabMejorEquipo").dataTable({
            "info": false,
            "bServerSide": false,
            "data": _dataMejorEquipo_,
            "order": [[1, "asc"]],
            "columns": [
                {
                    "bSortable": false,
                    "sClass": "center",
                    "sWidth": "5%",
                    "render": function (data, type, row) {
                        return "<input type='checkbox' name='chkAuditorServicio' value='" + row[0] + "#" + row[7] + "' />"
                    }
                },
                { "sTitle": "Auditor" },
                { "sTitle": "Cargo" },
                { "sTitle": "Ptos. Experiencia", "sClass": "center" },
                { "sTitle": "Ptos. Capacitacion", "sClass": "center" },
                { "sTitle": "Ptos.q Totales", "sClass": "center" },
                { "sTitle": "Hrs. Disponible", "sClass": "center" }
            ]

        });


        function listarMejorEquipo(idPublica, idSerAud) {

            $.ajax({
                url: '@Url.Action("ListarMejorEquipo", "InvitacionAuditor")',
                type: 'POST',
                async: false,
                data: { idPub: idPublica, idSerAud: idSerAud  },
                success: function (result) {
                    _dataMejorEquipo_ = result;
                    tabMejorEquipo.fnReloadData(_dataMejorEquipo_);
                    tabMejorEquipo.fnDraw();
                }
            });
        }


        var tabAuditoresAptos = $("#tabAuditoresAptos").dataTable({
            "info": false,
            "bServerSide": false,
            "data": _dataAuditoresAptos_,
            "order": [[1, "asc"]],
            "columns": [
                {
                    "bSortable": false,
                    "sClass": "center",
                    "sWidth": "5%",
                    "render": function (data, type, row) {
                        return "<input type='checkbox' name='chkAuditorServicio' value='" + row[0] + "#" + row[7] + "' />"
                    }
                },
                { "sTitle": "Auditor" },
                { "sTitle": "Cargo" },
                { "sTitle": "Ptos. Experiencia", "sClass": "center" },
                { "sTitle": "Ptos. Capacitacion", "sClass": "center" },
                { "sTitle": "Ptos.q Totales", "sClass": "center" },
                { "sTitle": "Hrs. Disponible", "sVisible": false, "sClass": "center" }
            ]

        });

        function listarAuditoresAptos(idPublica, idSerAud) {

            $.ajax({
                url: '@Url.Action("ListarAuditoresAptos", "InvitacionAuditor")',
                type: 'POST',
                async: false,
                data: { idPub: idPublica, idSerAud: idSerAud },
                success: function (result) {
                    _dataAuditoresAptos_ = result;
                    tabAuditoresAptos.fnReloadData(_dataAuditoresAptos_);
                }
            });
        }

    </script>
}
